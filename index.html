<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Audioguide der Ev. Stadtkirche von Hessisch Lichtenau</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#f1f3f5" />
  <meta name="robots" content="noindex,nofollow,noarchive,nosnippet" />
  <meta name="googlebot" content="noindex,nofollow,noarchive,nosnippet" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    :root{
      --bg:#f1f3f5; --card:#f6f7f9; --fg:#2b3035; --muted:#6b7280; --line:#d9dee5;
      --play:#0f172a; --accent:#0f172a; --pill:#eceff3;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      -webkit-font-smoothing:antialiased;
    }
    .wrap{max-width:760px;margin:0 auto;padding:10px 12px 18px;display:flex;flex-direction:column;gap:10px}

    .topbar{min-height:48px;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .title{font-size:14px;font-weight:400;color:var(--muted);margin-right:8px}

    .lang-select{display:inline-flex;align-items:center;gap:8px}
    .lang-select label{font-size:12px;color:var(--muted)}
    .select{position:relative;display:inline-block;background:var(--pill);border:1px solid var(--line);border-radius:999px;overflow:hidden;padding:0 8px}
    .select select{appearance:none;border:0;background:transparent;padding:6px 26px 6px 8px;font-size:12px;font-weight:600;color:var(--fg);cursor:pointer;outline:none}
    .select::after{content:"â–¾";position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--muted);pointer-events:none}

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:10px}

    .cover-wrap{position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--line);width:100%;aspect-ratio:1/1;background:#e6eaef;}
    .cover{width:100%;height:100%;object-fit:cover;display:block}

    .scrub-overlay{position:absolute;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(180deg, rgba(241,243,245,0) 0%, rgba(246,247,249,.9) 40%, rgba(246,247,249,.95) 100%)}
    .progress{position:relative;width:100%;height:6px;border-radius:999px;background:#e2e7ee;border:1px solid var(--line);cursor:pointer;touch-action:none}
    .bar{position:absolute;left:0;top:0;height:100%;width:0%;background:var(--accent);border-radius:999px}
    .thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 3px rgba(15,23,42,.08)}
    .thumb::after{content:"";position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:32px;height:32px}
    .times{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:6px}

    .controls{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;margin-top:2px}
    .skip{justify-self:center;display:inline-flex;align-items:center;gap:6px;color:var(--muted);font-size:14px;background:transparent;border:0;cursor:pointer}
    .skip svg{width:16px;height:16px;opacity:.65;fill:currentColor}
    .play{width:66px;height:66px;border-radius:50%;background:var(--play);color:#fff;border:0;cursor:pointer;display:grid;place-items:center}
    .play svg{width:24px;height:24px;fill:#fff}

    .speed{display:flex;align-items:center;gap:8px;justify-content:center;margin-top:6px}
    .speed .label{font-size:12px;color:var(--muted)}
    .speed button{border:1px solid var(--line);background:#eef2f6;color:#2f3640;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer}
    .speed button.active{border-color:#b7c2cf;box-shadow:0 0 0 1px #b7c2cf inset}

    footer{color:#7d8590;text-align:center;font-size:12px;margin-top:6px}
    footer div{margin:4px 0}
    footer a{color:#7d8590;text-decoration:none}
    footer a:hover{text-decoration:underline;color:#2b3035}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal[open]{display:flex}
    .modal-card{width:min(780px,92vw);max-height:86vh;background:#fff;color:#1f2530;border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .modal-head{display:flex;justify-content:space-between;padding:12px 16px;background:#f6f7f9}
    .modal-body{padding:14px 16px;overflow:auto;font-size:14px;line-height:1.55}

    .copy{border:1px solid var(--line);background:#f1f3f5;font-size:11px;padding:2px 6px;border-radius:6px;cursor:pointer}
    .copy:hover{background:#e5e7eb}
    .don-input{border:1px solid var(--line);border-radius:8px;padding:4px 8px;width:70px;text-align:right}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">Audioguide der Ev. Stadtkirche von Hessisch Lichtenau</div>
      <div class="lang-select">
        <label for="lang">Sprache</label>
        <div class="select">
          <select id="lang" aria-label="Sprache wÃ¤hlen">
            <option value="de">ðŸ‡©ðŸ‡ª Deutsch</option>
            <option value="en">ðŸ‡¬ðŸ‡§ English</option>
            <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
            <option value="it">ðŸ‡®ðŸ‡¹ Italiano</option>
            <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
          </select>
        </div>
      </div>
    </div>

    <section class="card">
      <div class="cover-wrap">
        <img src="cover.jpeg" alt="Cover" class="cover" />
        <div class="scrub-overlay">
          <div class="progress" id="progress">
            <div class="bar" id="bar"></div>
            <div class="thumb" id="thumb"></div>
          </div>
          <div class="times"><span id="cur">0:00</span><span id="dur">0:00</span></div>
        </div>
      </div>

      <div class="controls">
        <button id="back15" class="skip" aria-label="15 Sekunden zurÃ¼ck">
          <svg viewBox="0 0 24 24"><path d="M15 6l-6 6 6 6"/></svg>
          <span>-15s</span>
        </button>
        <button id="btn-play" class="play" aria-label="Abspielen">
          <svg id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7-11-7z"/></svg>
          <svg id="icon-pause" viewBox="0 0 24 24" style="display:none"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>
        </button>
        <button id="fwd15" class="skip" aria-label="15 Sekunden vor">
          <span>+15s</span>
          <svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6"/></svg>
        </button>
      </div>

      <div class="speed">
        <span class="label">Tempo</span>
        <button data-rate="0.8">0.8Ã—</button>
        <button data-rate="1" class="active">1Ã—</button>
        <button data-rate="1.1">1.1Ã—</button>
        <button data-rate="1.25">1.25Ã—</button>
      </div>
    </section>

    <footer>
      <div style="margin:8px 0">
        <button id="openDonate" style="border:1px solid #d9dee5;background:#0f172a;color:#fff;padding:10px 14px;border-radius:999px;cursor:pointer">
          Jetzt fÃ¼r die Kirchengemeinde spenden
        </button>
      </div>

      <div>Â© <span id="year"></span> Evangelische Stadtkirche Hessisch Lichtenau</div>
      <div>Intro und Outro Musik: Track London, Musik von
        <a href="https://www.fiftysounds.com" target="_blank">fiftysounds.com</a>
      </div>

      <div style="margin-top:6px">
        <a class="legal-link" id="openLegal">Impressum und Datenschutz</a>
      </div>
    </footer>
  </div>

  <audio id="audio" preload="metadata"></audio>

  <div class="modal" id="legalModal">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Impressum und Datenschutz</h3>
        <button id="closeLegal">âœ•</button>
      </div>
      <div class="modal-body">
        <h4>Impressum</h4>
        <p><strong>Ev. Kirchengemeinde Hessisch Lichtenau</strong><br>
        MÃ¼hlweg 21, 37235 Hessisch Lichtenau<br>
        Telefon: 05602 2403<br>
        E Mail: <a href="mailto:hessischlichtenau.gemeindebuero@ekkw.de">hessischlichtenau.gemeindebuero@ekkw.de</a></p>
        <p>Die Ev. Kirchengemeinde Hessisch Lichtenau ist eine KÃ¶rperschaft des Ã¶ffentlichen Rechts. Vertretungsberechtigt ist der Kirchenvorstand.</p>
        <h4>Verantwortlich nach Â§18 MStV</h4>
        <p>Pfarrerin Anja Peters, MÃ¼hlweg 21, 37235 Hessisch Lichtenau</p>
        <h4>Datenschutz</h4>
        <p>Es werden keine Tracking Dienste oder Cookies eingesetzt. Technisch notwendige Protokolle des Hosting Providers werden nur kurzzeitig gespeichert.</p>
        <p>Die lokale Speicherung von Sprache und Wiedergabegeschwindigkeit erfolgt ausschlieÃŸlich in Ihrem Browser und kann jederzeit gelÃ¶scht werden.</p>
        <h4>Ihre Rechte</h4>
        <p>Nach DSGVO. Auskunft, Berichtigung, LÃ¶schung, EinschrÃ¤nkung, Widerspruch und DatenÃ¼bertragbarkeit. Beschwerden bei der AufsichtsbehÃ¶rde sind mÃ¶glich.</p>
        <h4>Musiknachweis</h4>
        <p>Intro und Outro Musik. Track London, Musik von <a href="https://www.fiftysounds.com" target="_blank">www.fiftysounds.com</a>.</p>
      </div>
    </div>
  </div>

  <div class="modal" id="donateModal">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Spende an die Kirchengemeinde Hessisch Lichtenau</h3>
        <button id="closeDonate">âœ•</button>
      </div>
      <div class="modal-body">
        <p>Vielen Dank fÃ¼r Ihre UnterstÃ¼tzung. Sie kÃ¶nnen direkt per BankÃ¼berweisung spenden. Scannen Sie den QR Code mit Ihrer Banking App oder Ã¼bernehmen Sie die Daten manuell.</p>
        <div style="margin-bottom:10px">
          <label for="don-amount">Betrag (â‚¬). </label>
          <input id="don-amount" class="don-input" type="number" value="5" min="1" step="0.5">
        </div>
        <canvas id="donateQR" style="width:200px;height:200px;border:1px solid #d9dee5;border-radius:8px;background:#fff"></canvas>
        <div style="margin-top:10px">
          <div><strong>EmpfÃ¤nger.</strong> <span id="don-name">Kirchenkreisamt Eschwege</span> <button class="copy" data-copy="#don-name">Kopieren</button></div>
          <div><strong>IBAN.</strong> <span id="don-iban">DE91520604100001200100</span> <button class="copy" data-copy="#don-iban">Kopieren</button></div>
          <div><strong>Verwendungszweck.</strong> <span id="don-ref">Kirchengemeinde, Hessisch Lichtenau, Audioguide Spende</span> <button class="copy" data-copy="#don-ref">Kopieren</button></div>
        </div>
        <p style="font-size:12px;color:#6b7280;margin-top:10px">
          FÃ¼r Spendenbescheinigungen geben Sie bitte im Verwendungszweck zusÃ¤tzlich Ihren Namen und Ihre Anschrift an.
        </p>
      </div>
    </div>
  </div>

  <script>
    (()=>{
      // feste Dateinamen fÃ¼r FranzÃ¶sisch
      const FR = {
        inside: "Audioguide Stadtkirche (fr).mp3",
        outside: "Audioguide Stadtkirche auÃŸen (fr).mp3"
      };
      const labels = { de:"deutsch", en:"englisch", it:"italienisch", es:"spanisch" };

      // schneller Existenztest per HEAD, mit Range Fallback
      async function urlExists(url){
        const enc = encodeURI(url);
        try{
          const head = await fetch(enc, { method: "HEAD", cache: "no-cache" });
          if(head.ok) return enc;
          if(head.status === 405 || head.status === 501){
            const getSmall = await fetch(enc, { method: "GET", headers: { "Range": "bytes=0-0" }, cache: "no-cache" });
            if(getSmall.ok) return enc;
          }
        }catch(e){}
        return null;
      }

      function buildCandidates(area, lang){
        if(lang === "fr"){
          const base = area === "outside" ? FR.outside : FR.inside;
          return [base, base.replace("auÃŸen","aussen")];
        }
        const label = labels[lang] || "deutsch";
        const prefix = area === "outside" ? "Audioguide Stadtkirche auÃŸen" : "Audioguide Stadtkirche";
        return [
          `${prefix} (${label}).mp3`,
          `${prefix.replace("auÃŸen","aussen")} (${label}).mp3`,
          `${prefix} (${label.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}).mp3`,
          `${prefix} (${label.replace(/Ã¤/g,"ae").replace(/Ã¶/g,"oe").replace(/Ã¼/g,"ue").replace(/ÃŸ/g,"ss").replace(/Ã„/g,"Ae").replace(/Ã–/g,"Oe").replace(/Ãœ/g,"Ue")}).mp3`
        ];
      }

      async function resolveBestSrc(area, lang){
        const candidates = buildCandidates(area, lang);
        for(const c of candidates){
          const ok = await urlExists(c);
          if(ok) return ok;
        }
        // Fallback nur wenn wirklich nichts erreichbar ist
        return encodeURI("Audioguide Stadtkirche (deutsch).mp3");
      }

      const audio=document.getElementById("audio"),
            btnPlay=document.getElementById("btn-play"),
            iconPlay=document.getElementById("icon-play"),
            iconPause=document.getElementById("icon-pause"),
            back15=document.getElementById("back15"),
            fwd15=document.getElementById("fwd15"),
            progress=document.getElementById("progress"),
            bar=document.getElementById("bar"),
            thumb=document.getElementById("thumb"),
            cur=document.getElementById("cur"),
            dur=document.getElementById("dur"),
            selectLang=document.getElementById("lang");

      document.getElementById("year").textContent=new Date().getFullYear();

      const params=new URLSearchParams(location.search);
      let area=(params.get("area")==="outside"||params.get("area")==="inside") ? params.get("area") : (localStorage.getItem("hl-area")||"inside");
      const supported=["de","en","fr","it","es"];
      function normalizeLang(v){return supported.includes(v)?v:"de";}
      let lang=normalizeLang(params.get("lang")||localStorage.getItem("hl-lang")||"de");
      selectLang.value=lang;

      const fmt=s=>(isNaN(s)||!isFinite(s))?"0:00":`${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,"0")}`;
      function updatePlayIcon(showPlay){iconPlay.style.display=showPlay?"block":"none";iconPause.style.display=showPlay?"none":"block";}
      function updateProgressUI(){if(!audio.duration)return;const pct=(audio.currentTime/audio.duration)*100;bar.style.width=pct+"%";thumb.style.left=pct+"%";cur.textContent=fmt(audio.currentTime);dur.textContent=fmt(audio.duration);}

      async function setSource(autoplay){
        localStorage.setItem("hl-area",area);
        localStorage.setItem("hl-lang",lang);
        const u=new URL(location.href);
        u.searchParams.set("area",area);
        u.searchParams.set("lang",lang);
        history.replaceState({}, "", u);

        const src=await resolveBestSrc(area,lang);
        if(audio.getAttribute("src")!==src){
          audio.src=src;
          audio.load();
        }
        if(autoplay){
          audio.play().then(()=>updatePlayIcon(false)).catch(()=>updatePlayIcon(true));
        }
      }

      function startPlayback(){audio.play().then(()=>updatePlayIcon(false)).catch(()=>updatePlayIcon(true));}

      // Start ohne Autoplay
      setSource(false);

      selectLang.addEventListener("change", e=>{
        lang = normalizeLang(e.target.value);
        setSource(true);
      });

      btnPlay.onclick=()=>{if(audio.paused){startPlayback();}else{audio.pause();updatePlayIcon(true);}};
      back15.onclick=()=>{audio.currentTime=Math.max(0,audio.currentTime-15);updateProgressUI();};
      fwd15.onclick=()=>{audio.currentTime=Math.min(audio.duration||audio.currentTime+15,audio.currentTime+15);updateProgressUI();};
      audio.addEventListener("loadedmetadata",updateProgressUI);
      audio.addEventListener("timeupdate",updateProgressUI);
      audio.addEventListener("ended",()=>updatePlayIcon(true));

      // Ziehen des Fortschrittsbalkens
      let seeking=false;
      let activePointerId=null;

      function pctFromClientX(clientX){
        const r=progress.getBoundingClientRect();
        const x=clientX - r.left;
        return Math.min(Math.max(0, x / r.width), 1);
      }
      function seekToPercent(p){
        if(!audio.duration) return;
        audio.currentTime = p * audio.duration;
        updateProgressUI();
      }
      function onPointerDown(e){
        e.preventDefault();
        seeking=true;
        activePointerId=e.pointerId||1;
        progress.setPointerCapture?.(activePointerId);
        seekToPercent(pctFromClientX(e.clientX));
      }
      function onPointerMove(e){
        if(!seeking) return;
        if(activePointerId!=null && e.pointerId!=null && e.pointerId!==activePointerId) return;
        seekToPercent(pctFromClientX(e.clientX));
      }
      function onPointerUp(e){
        if(activePointerId!=null && e.pointerId!=null && e.pointerId!==activePointerId) return;
        seeking=false;
        progress.releasePointerCapture?.(activePointerId);
        activePointerId=null;
      }

      ["pointerdown","pointermove","pointerup","pointercancel","pointerleave"].forEach(ev=>{
        if(ev==="pointerdown"){
          progress.addEventListener(ev,onPointerDown);
          thumb.addEventListener(ev,onPointerDown);
        }else if(ev==="pointermove"){
          progress.addEventListener(ev,onPointerMove);
          thumb.addEventListener(ev,onPointerMove);
        }else{
          progress.addEventListener(ev,onPointerUp);
          thumb.addEventListener(ev,onPointerUp);
        }
      });

      // Impressum und Datenschutz
      const legalModal=document.getElementById("legalModal");
      document.getElementById("openLegal").onclick=()=>legalModal.setAttribute("open","");
      document.getElementById("closeLegal").onclick=()=>legalModal.removeAttribute("open");
      legalModal.onclick=(e)=>{if(e.target===legalModal)legalModal.removeAttribute("open");};

      // Spendenbereich
      const donateModal=document.getElementById("donateModal");
      document.getElementById("openDonate").onclick=()=>donateModal.setAttribute("open","");
      document.getElementById("closeDonate").onclick=()=>donateModal.removeAttribute("open");
      donateModal.onclick=(e)=>{if(e.target===donateModal)donateModal.removeAttribute("open");};
      document.querySelectorAll(".copy").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const sel=btn.getAttribute("data-copy");
          const el=document.querySelector(sel);
          if(!el)return;
          navigator.clipboard.writeText(el.textContent.trim()).then(()=>{
            btn.textContent="Kopiert";
            setTimeout(()=>btn.textContent="Kopieren",1500);
          });
        });
      });
      const qrCanvas=document.getElementById("donateQR");
      const amountInput=document.getElementById("don-amount");
      function genQR(){
        const amount=parseFloat(amountInput.value)||0;
        const epc=`BCD
001
1
SCT

Kirchenkreisamt Eschwege
DE91520604100001200100
EUR${amount.toFixed(2)}
Kirchengemeinde, Hessisch Lichtenau, Audioguide Spende`;
        QRCode.toCanvas(qrCanvas, epc, {margin:1,width:200});
      }
      amountInput.addEventListener("input", genQR);
      genQR();
    })();
  </script>
</body>
</html>
